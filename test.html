<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Document</title>
  <style>
  </style>
</head>
<body>
  <input id="imgInput" type="file" accept=".png, .jpg, .bmp, .jpeg"/>
  <input id="slider" type="range"/>

  <img id="img"/>
  <img id="result"/>
  <button>Cancel</button>
  <script>
    let imgInput = document.getElementById("imgInput");
    let slider = document.getElementById("slider");
    let quality = 0.5
    slider.onchange = () => {
      quality = 0.5 + slider.value/220
      img.src = img.src
    }
    imgInput.onchange = (e) => {
      let file = e.target.files[0];
      let reader = new FileReader();
      reader.readAsDataURL(file);
      reader.onload = () => {
        img.src = reader.result;
      }
    }
    
    let c = document.createElement('canvas');
    let ctx = c.getContext('2d', {willReadFrequently: true});
    var img = document.getElementById("img")
    let pixels = [];
    img.onload = () => {
      let t1 = new Date().getTime()
      c.height = img.height;
      c.width = img.width;
      ctx.drawImage(img, 0, 0, img.width, img.height);
      let data = ctx.getImageData(0, 0, img.width, img.height);
      for(let i = 0; i < data.height; i++){
        pixels[i] = [];
        for(let j = 0; j < data.width; j++){
          let p = new Pixel(data.data[(i*data.width+j)*4], data.data[(i*data.width+j)*4+1], data.data[(i*data.width+j)*4+2], data.data[(i*data.width+j)*4+3])
          pixels[i][j] = p;
        }
      }

      let k = new Kernel(10, pixels)
      let count = 0
      for(i = 0; i < pixels.length; i++){
        for(j = 0; j < pixels[i].length; j++){
          let pBrightness = pixels[i][j].getBrightness()
          if(pBrightness < 80 * (1 + slider.value/10)){
            if(pBrightness < k.getAvgBrightness(j, i) * quality){
              data.data[count] = 0
              data.data[count+1] = 0
              data.data[count+2] = 0
              data.data[count+3] = 255
            }
            else{
              data.data[count] = 0
              data.data[count+1] = 0
              data.data[count+2] = 0
              data.data[count+3] = 0
            }
          }else{
            data.data[count] = 0
            data.data[count+1] = 0
            data.data[count+2] = 0
            data.data[count+3] = 0
          }
          count += 4
        }
      }
      
      ctx.putImageData(data, 0, 0)
      document.getElementById("result").src = c.toDataURL()
      console.log(new Date().getTime() - t1)
    }

    // img.onmousemove = (e) => {
    //   let x = Math.floor(e.offsetX)
    //   let y = Math.floor(e.offsetY)
    //   let k = new Kernel(3, pixels)
    //   // console.log(x, y, pixels[x][y])
    //   console.log(k.getMatrix(x, y))
    // }
  
    
    class Kernel{
      constructor(size, pixels){
        if(size%2 == 0){
          size++
        }
        this.size = size;
        this.matrix = [];
        this.pixels = pixels;
        this.brightness = 0
      }

      getMatrix(x, y){
        this.matrix = []
        this.calcMatrix(x, y)
        return this.matrix;
      }

      getAvgBrightness(x, y){
        let initX = x - Math.ceil(this.size/2)
        let initY = y - Math.ceil(this.size/2)
        let r = 0;
        let g = 0;
        let b = 0;
        for(let i = 0; i < this.size; i++){
          for(let j = 0; j < this.size; j++){
            try {
              let p = this.pixels[initY+i][initX+j]
              if(p){
                r += p.r
                g += p.g
                b += p.b
              }
            } catch (error) {
            }
          }
        }
        this.brightness = (r + g + b) / (this.size * this.size)
        return this.brightness
      }

      calcMatrix(x, y){
        let initX = x - Math.ceil(this.size/2)
        let initY = y - Math.ceil(this.size/2)
        for(let i = 0; i < this.size; i++){
          this.matrix.push([]);
          for(let j = 0; j < this.size; j++){
            try {
              let p = this.pixels[initY+i][initX+j]
              if(p){
                this.matrix[i].push(p)
              }
              else
                this.matrix[i].push(new Pixel(0, 0, 0, 255))
            } catch (error) {
              this.matrix[i].push(new Pixel(0, 0, 0, 255))
            }
          }
        }
      }
    }


    class Pixel {
      constructor(r, g, b, a) {
        this.r = r;
        this.g = g;
        this.b = b;
        this.a = a;
      }

      // converting scale from 0 - 255 to 0 - 10
      getBrightness(){
        return (this.r + this.g + this.b)
      }
    }

    

  </script>
</body>
</html>